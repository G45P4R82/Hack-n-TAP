---
- name: Deploy DEV - Django + MariaDB via Docker
  hosts: all
  become: true

  vars:
    network_name: hack-n-tap-net

    db_container_name: database
    db_image: mariadb:10.11
    db_name: beerbase
    db_user: root
    db_password: tijolo44
    db_port: 3306

    app_container_name: hack-n-tap-dev
    app_image: srmarinho/hack-n-tap:latest
    app_port: 8000

    django_superuser_username: tap
    django_superuser_email: tap@tap.lhc
    django_superuser_password: tijolo22

  tasks:

    - name: Criar network Docker (se nÃ£o existir)
      command: docker network create {{ network_name }}
      ignore_errors: yes

    - name: Parar container DB antigo (se existir)
      command: docker stop {{ db_container_name }}
      ignore_errors: yes

    - name: Remover container DB antigo (se existir)
      command: docker rm {{ db_container_name }}
      ignore_errors: yes

    - name: Subir MariaDB
      command: >
        docker run -d
        --name {{ db_container_name }}
        --network {{ network_name }}
        -e MYSQL_ROOT_PASSWORD={{ db_password }}
        -e MYSQL_DATABASE={{ db_name }}
        -p {{ db_port }}:3306
        --restart unless-stopped
        {{ db_image }}

    - name: Aguardar MariaDB inicializar
      pause:
        seconds: 15

    - name: Parar container APP antigo (se existir)
      command: docker stop {{ app_container_name }}
      ignore_errors: yes

    - name: Remover container APP antigo (se existir)
      command: docker rm {{ app_container_name }}
      ignore_errors: yes

    - name: Subir Django
      command: >
        docker run -d
        --name {{ app_container_name }}
        --network {{ network_name }}
        -p {{ app_port }}:8000
        -e DATABASE_URL=mysql://{{ db_user }}:{{ db_password }}@{{ db_container_name }}:3306/{{ db_name }}
        -e DJANGO_SUPERUSER_USERNAME={{ django_superuser_username }}
        -e DJANGO_SUPERUSER_EMAIL={{ django_superuser_email }}
        -e DJANGO_SUPERUSER_PASSWORD={{ django_superuser_password }}
        --restart unless-stopped
        {{ app_image }}
        bash -c "
          python manage.py migrate &&
          python manage.py createsuperuser --noinput || true &&
          python manage.py runserver 0.0.0.0:8000
        "

    - name: Aguardar APP inicializar
      pause:
        seconds: 10

    - name: Verificar status da APP
      command: docker inspect -f '{{ "{{.State.Status}}" }}' {{ app_container_name }}
      register: app_status
      changed_when: false
      failed_when: app_status.stdout != "running"

    - name: Mostrar logs da APP
      command: docker logs {{ app_container_name }}
      register: app_logs
      changed_when: false
      ignore_errors: yes

    - name: Exibir logs da APP
      debug:
        msg: "{{ app_logs.stdout_lines }}"

    - name: Descobrir IP da mÃ¡quina
      command: hostname -I
      register: host_ip
      changed_when: false

    - name: InformaÃ§Ãµes finais
      debug:
        msg:
          - "ğŸš€ Deploy DEV concluÃ­do"
          - "ğŸŒ App: http://{{ host_ip.stdout.split()[0] }}:{{ app_port }}"
          - "ğŸ” Admin: http://{{ host_ip.stdout.split()[0] }}:{{ app_port }}/admin"
          - "ğŸ—„ï¸ DB Host: {{ db_container_name }}"
          - "ğŸ‘¤ DB User: root"
          - "ğŸ”‘ DB Password: {{ db_password }}"
