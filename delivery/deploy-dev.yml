---
- name: Deploy DEV - Django via Docker
  hosts: all
  become: true

  vars:
    container_name: hack-n-tap-dev
    image_name: srmarinho/hack-n-tap:latest

    app_port: 8000
    container_port: 8000

    django_superuser_username: tap
    django_superuser_email: tap@tap.lhc
    django_superuser_password: tijolo22

  tasks:

    - name: Docker pull da imagem
      command: docker pull {{ image_name }}

    - name: Parar container antigo (se existir)
      command: docker stop {{ container_name }}
      ignore_errors: yes

    - name: Remover container antigo (se existir)
      command: docker rm {{ container_name }}
      ignore_errors: yes

    - name: Subir novo container Django
      command: >
        docker run -d
        --name {{ container_name }}
        -p {{ app_port }}:{{ container_port }}
        -e DJANGO_SUPERUSER_USERNAME={{ django_superuser_username }}
        -e DJANGO_SUPERUSER_EMAIL={{ django_superuser_email }}
        -e DJANGO_SUPERUSER_PASSWORD={{ django_superuser_password }}
        --restart unless-stopped
        {{ image_name }}
        bash -c "
          python manage.py migrate &&
          python manage.py createsuperuser --noinput || true &&
          python manage.py runserver 0.0.0.0:8000
        "
      register: docker_run
      failed_when: docker_run.rc != 0

    - name: Aguardar container inicializar
      pause:
        seconds: 10

    - name: Verificar status do container
      command: docker inspect -f '{{ "{{.State.Status}}" }}' {{ container_name }}
      register: container_status
      changed_when: false
      failed_when: container_status.stdout != "running"

    - name: Mostrar status do container
      debug:
        msg: "ğŸ“¦ Container status: {{ container_status.stdout }}"

    - name: Mostrar logs do container
      command: docker logs {{ container_name }}
      register: docker_logs
      changed_when: false
      ignore_errors: yes

    - name: Exibir logs do container
      debug:
        msg: "{{ docker_logs.stdout_lines | default(['(sem logs ainda)']) }}"

    - name: Descobrir IP da mÃ¡quina
      command: hostname -I
      register: host_ip
      changed_when: false

    - name: InformaÃ§Ãµes finais de acesso
      debug:
        msg:
          - "ğŸš€ Deploy concluÃ­do com sucesso"
          - "ğŸ“¦ Container: {{ container_name }}"
          - "ğŸŒ App: http://{{ host_ip.stdout.split()[0] }}:{{ app_port }}"
          - "ğŸ” Admin: http://{{ host_ip.stdout.split()[0] }}:{{ app_port }}/admin"
          - "ğŸ‘¤ UsuÃ¡rio: {{ django_superuser_username }}"
          - "ğŸ”‘ Senha: {{ django_superuser_password }}"
